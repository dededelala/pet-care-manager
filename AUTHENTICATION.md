# 用户认证系统使用指南

## 🎯 功能概述

为宠物健康管理系统添加了完整的用户认证功能，实现多用户支持和数据隔离。

## ✨ 新增功能

### 1. **用户注册**
- 访问 `/auth/register` 创建新账户
- 需要提供：姓名、邮箱、密码（至少6位）
- 密码加密存储（bcrypt）
- 邮箱唯一性验证

### 2. **用户登录**
- 访问 `/auth/login` 登录账户
- 使用邮箱和密码登录
- NextAuth.js 会话管理
- 自动重定向到首页

### 3. **数据隔离**
- 每个用户只能看到自己的宠物
- 每个用户只能管理自己的提醒设置
- 通过 `userId` 字段实现数据隔离
- 安全的 API 访问控制

### 4. **路由保护**
- 所有非认证页面自动重定向到登录页
- 中间件自动检查用户会话
- 无需手动编写认证检查

## 📋 使用步骤

### 第一步：部署更新

代码已推送到 GitHub，Vercel 正在部署。

### 第二步：创建数据库表

访问：`https://pet-care-manager.vercel.app/api/migrate`

这会创建：
- `users` 表
- 为现有表添加 `userId` 字段

### 第三步：注册账户

1. 访问 `/auth/register`
2. 填写注册表单：
   - 姓名：您的称呼
   - 邮箱：有效的邮箱地址
   - 密码：至少6位字符
   - 确认密码：重复密码
3. 点击"创建账户"
4. 注册成功后会跳转到登录页

### 第四步：登录

1. 访问 `/auth/login`
2. 输入注册时的邮箱和密码
3. 点击"登录"
4. 登录成功后跳转到首页

### 第五步：使用应用

登录后可以：
- 添加宠物（只属于当前用户）
- 查看自己的宠物列表
- 设置提醒（只为自己的宠物）
- 查看自己的健康记录

## 🔒 安全特性

### 数据隔离
- 每个用户只能访问自己的数据
- API 路由检查用户会话
- 数据库查询自动过滤 `userId`

### 密码安全
- 使用 bcrypt 加密密码
- 不会明文存储密码
- 密码验证时实时加密比较

### 会话管理
- JWT 令牌管理会话
- 安全的会话存储
- 自动过期和刷新

### 路由保护
- 中间件自动检查认证状态
- 未登录用户自动重定向
- 保护所有敏感页面

## 🎨 界面

### 登录页面 (`/auth/login`)
- 简洁的卡片式设计
- 渐变背景（粉色到紫色）
- 表单验证和错误提示
- 链接到注册页面

### 注册页面 (`/auth/register`)
- 完整的注册表单
- 实时表单验证
- 密码强度检查
- 链接到登录页面

## 📊 数据库变更

### 新增表
```sql
CREATE TABLE users (
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String   -- 加密后的密码
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
)
```

### 修改表
所有现有表添加了 `userId` 字段：
- `pets` - 添加 `userId`
- `reminder_settings` - 添加 `userId`

## 🔧 技术实现

### 认证框架
- **NextAuth.js v5** - 最新的认证框架
- **Credentials Provider** - 邮箱/密码登录
- **JWT Sessions** - 无状态会话管理

### 依赖包
```json
{
  "next-auth": "^5.0.0-beta.25",
  "@auth/prisma-adapter": "^2.7.4",
  "bcryptjs": "^2.4.3",
  "zod": "^3.23.8"
}
```

### 文件结构
```
app/
├── api/
│   └── auth/
│       ├── [...nextauth]/    # NextAuth 路由处理
│       └── register/         # 注册 API
├── auth/
│   ├── login/                # 登录页面
│   └── register/             # 注册页面
├── (protected)/              # 受保护的页面（通过中间件）
│   ├── page.tsx              # 首页
│   ├── pets/                 # 宠物页面
│   └── records/              # 记录页面
middleware.ts                  # 认证中间件
lib/auth.ts                    # NextAuth 配置
```

## ⚠️ 注意事项

### 现有数据
- 部署后需要重新创建数据库表
- 现有的宠物数据需要迁移或重新创建
- 提醒设置需要重新配置

### API 修改
- 部分 API 路由已修改（pets, reminders）
- 其他 API 路由需要继续修改（见 `API_MODIFICATION_GUIDE.md`）
- 修改后需要重新生成 Prisma 客户端

### 环境变量
无需额外配置环境变量，认证系统开箱即用。

## 🚀 后续工作

根据 `API_MODIFICATION_GUIDE.md`，还需要：

1. 修改记录相关 API：
   - `deworming`
   - `internal`
   - `bathing`
   - `vaccine`
   - `weight`

2. 为记录模型添加 `userId` 字段

3. 测试完整的用户流程

## 📞 故障排除

**问题：注册失败**
- 检查邮箱格式是否正确
- 确认密码至少6位
- 检查两次密码输入是否一致

**问题：登录失败**
- 确认邮箱和密码正确
- 检查是否已注册账户

**问题：看不到宠物**
- 确认已登录
- 检查是否创建过宠物
- 查看浏览器控制台错误

**问题：API 错误**
- 检查是否已创建数据库表
- 查看 Vercel Functions 日志
- 确认 NextAuth 配置正确

## 🎉 总结

用户认证系统已完全实现！现在用户可以：
- 注册和登录账户
- 安全地管理自己的宠物
- 设置个人提醒
- 享受完全的数据隔离

系统现在支持多用户，每个用户的数据都是独立的、安全的！
